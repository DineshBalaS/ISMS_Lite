<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen px-4 py-6">
    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
          Admin Dashboard - All Risks
        </h2>
        <a
          href="{{ url_for('logout') }}"
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
          >Logout</a
        >
      </div>

      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
        <p class="text-gray-600 mb-2 md:mb-0">
          Below is the list of all risks reported by all users.
        </p>
        <div class="flex justify-end">
          <a
            href="{{ url_for('export_all_risks') }}"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
          >
            Export All as CSV
          </a>
        </div>
      </div>      
      <div class="my-4 flex flex-col md:flex-row gap-6">
        <div>
          <label for="impactFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Impact</label>
          <select id="impactFilter" class="form-select border border-gray-300 rounded px-3 py-2">
            <option value="">All</option>
            <option value="low">Low (1)</option>
            <option value="medium">Medium (2)</option>
            <option value="high">High (3)</option>
          </select>
        </div>
        <div>
          <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
          <select id="statusFilter" class="form-select border border-gray-300 rounded px-3 py-2">
            <option value="">All</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Mitigated">Mitigated</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
      </div>      
      <div class="overflow-x-auto max-h-[500px] overflow-y-scroll">
        <table
          id="adminRiskTable"
          class="min-w-full bg-white border rounded-lg overflow-hidden"
        >
          <thead class="bg-gray-100 text-gray-700 text-left">
            <tr>
              <th class="py-3 px-4 border-b">Title</th>
              <th class="py-3 px-4 border-b">Description</th>
              <th class="py-3 px-4 border-b">Impact</th>
              <th class="py-3 px-4 border-b">Likelihood</th>
              <th class="py-3 px-4 border-b">Risk Score</th>
              <th class="py-3 px-4 border-b">Risk Level</th>
              <th class="py-3 px-4 border-b">Owner ID</th>
              <th class="py-3 px-4 border-b">Created At</th>
              <th class="py-3 px-4 border-b">Status</th>
              <th class="py-3 px-4 border-b">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for risk in risks %}
            <tr class="border-b hover:bg-gray-50">
              <td class="py-2 px-4">{{ risk.title }}</td>
              <td class="py-2 px-4">{{ risk.description }}</td>
              <td class="py-2 px-4">{{ risk.impact }}</td>
              <td class="py-2 px-4">{{ risk.likelihood }}</td>
              <td class="py-2 px-4">{{ risk.risk_score }}</td>
              <td
                class="py-2 px-4 font-semibold capitalize {% if risk.risk_level == 'low' %} text-green-600 {% elif risk.risk_level == 'medium' %} text-yellow-600 {% elif risk.risk_level == 'high' %} text-red-600 {% endif %}"
                data-impact="{{ risk.risk_level | lower }}"
              >
                {{ risk.risk_level }}
              </td>

              <td class="py-2 px-4">{{ risk.owner_id }}</td>
              <td class="py-2 px-4">
                {{ risk.created_at.strftime('%Y-%m-%d') if risk.created_at else
                'N/A' }}
              </td>
              <td
                class="py-2 px-4 font-medium {% if risk.status == 'Open' %} text-blue-600 {% elif risk.status == 'In Progress' %} text-yellow-600 {% elif risk.status == 'Mitigated' %} text-green-600 {% elif risk.status == 'Closed' %} text-gray-500 {% endif %}"
              >
                {{ risk.status }}
              </td>
              <td class="py-2 px-4">
                <a href="{{ url_for('treat_risk', risk_id=risk.id) }}" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Treat</a>
              </td>              
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <!-- Charts Section -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-10">
        <!-- Risk Level Distribution Chart -->
        <div class="bg-white p-4 rounded-lg shadow border">
          <h3 class="text-lg font-semibold mb-2 text-gray-700">
            Risk Level Distribution
          </h3>
          <canvas id="riskLevelChart" height="200"></canvas>
        </div>

        <!-- Most Frequent Risk Levels Chart -->
        <div class="bg-white p-4 rounded-lg shadow border">
          <h3 class="text-lg font-semibold mb-2 text-gray-700">
            Most Frequent Risk Levels
          </h3>
          <canvas id="riskFreqChart" height="200"></canvas>
        </div>
      </div>

      <!-- Risks Over Time -->
      <div class="bg-white rounded shadow p-6 col-span-1 md:col-span-2">
        <h3 class="text-lg font-semibold mb-4">Risks Reported Over Time</h3>
        <canvas id="timeRiskChart"></canvas>
      </div>
      <!-- JSON-encoded risk data for charts -->
      <script id="riskDataJSON" type="application/json">
        {{ risk_data | tojson }}
      </script>

      <script id="timeChartData" type="application/json">
        {{ {"labels": risks_over_time_labels, "data": risks_over_time_data} | tojson }}
      </script>
    </div>
    <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
  </body>
</html>
