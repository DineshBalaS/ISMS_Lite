<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="container py-4">
    <h2 class="mb-4">Welcome, {{ current_user.username }}!</h2>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="{{ url_for('add_risk') }}" class="btn btn-primary"
        >Add New Risk</a
      >
      <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>

    <div class="mb-4">
      <h4 class="mb-2">Filter Risks</h4>
      <div class="d-flex gap-3 flex-wrap">
        <!-- Impact Filter -->
        <select id="impactFilter" class="form-select w-auto">
          <option value="">All Impacts</option>
          <option value="1">Low</option>
          <option value="2">Medium</option>
          <option value="3">High</option>
        </select>

        <!-- Status Filter -->
        <select id="statusFilter" class="form-select w-auto">
          <option value="">All Statuses</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Mitigated">Mitigated</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
    </div>

    <div class="table-responsive mb-4">
      <table class="table table-striped" id="riskTable">
        <thead class="table-light">
          <tr>
            <th onclick="sortTable(0)">Title</th>
            <th onclick="sortTable(1)">Description</th>
            <th onclick="sortTable(2)">Impact</th>
            <th onclick="sortTable(3)">Likelihood</th>
            <th onclick="sortTable(4)">Risk Level</th>
            <th class="py-3 px-4 border-b">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for risk in risks %}
          <tr>
            <td>{{ risk.title }}</td>
            <td>{{ risk.description }}</td>
            <td>{{ risk.impact }}</td>
            <td>{{ risk.likelihood }}</td>
            <td
              class="{% if risk.risk_level == 'low' %} text-success {% elif risk.risk_level == 'medium' %} text-warning {% elif risk.risk_level == 'high' %} text-danger {% endif %} fw-semibold"
              data-impact="{{ risk.risk_level | lower }}"
            >
              {{ risk.risk_level }}
            </td>

            <td
              class="{% if risk.status == 'Open' %} text-primary {% elif risk.status == 'In Progress' %} text-warning {% elif risk.status == 'Mitigated' %} text-success {% elif risk.status == 'Closed' %} text-muted {% endif %}"
            >
              {{ risk.status }}
            </td>
            <td>
              <a
                href="{{ url_for('edit_risk', risk_id=risk.id) }}"
                class="btn btn-sm btn-warning me-2"
                >Edit</a
              >
              <form
                action="{{ url_for('delete_risk', risk_id=risk.id) }}"
                method="POST"
                class="d-inline"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-danger"
                  onclick="return confirm('Are you sure you want to delete this risk?')"
                >
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mb-4">
      <button id="downloadReport" class="btn btn-primary me-2">
        Download Report
      </button>
      <button id="exportCsv" class="btn btn-success">Export as CSV</button>
    </div>

    <div class="mb-4">
      <h5 class="mb-3">Filter Chart</h5>
      <div class="d-flex flex-wrap align-items-center gap-3">
        <select id="chartRiskLevelFilter" class="form-select w-auto">
          <option value="">All Risk Levels</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>

        <input
          type="number"
          id="chartImpactMin"
          placeholder="Min Impact"
          class="form-control w-auto"
          min="1"
          max="3"
        />
        <input
          type="number"
          id="chartLikelihoodMin"
          placeholder="Min Likelihood"
          class="form-control w-auto"
          min="1"
          max="3"
        />
      </div>
    </div>

    <div class="mb-5">
      <h4 class="mb-3">Risk Level Distribution</h4>
      <div class="bg-light p-4 rounded shadow-sm">
        <canvas id="riskChart" height="200"></canvas>
      </div>
    </div>

    <script>
      const ctx = document.getElementById('riskChart').getContext('2d');
      const riskChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Low', 'Medium', 'High'],
          datasets: [{
            label: 'Number of Risks',
            data: [
              {{ risk_levels['low'] }},
              {{ risk_levels['medium'] }},
              {{ risk_levels['high'] }}
            ],
            backgroundColor: [
              'rgba(75, 192, 192, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(255, 99, 132, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Risks by Severity Level'
            }
          }
        }
      });
    </script>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  </body>
</html>
